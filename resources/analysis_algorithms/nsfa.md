# Non-stationary fluctuation analysis (NSFA)

Man Ho Wong  
Xu Lab, Department of Neuroscience, University of Pittsburgh.

This page documents the algorithm of NSFA, which is implemented through the function [`nsfa.m`](../../functions/kinetics/nsfa.m).

This algorithm is an optimized implementation of the analysis procedures described in Hartveit and Veruki (2007). It can be used for automatic analysis of large datasets containing miniature EPSC (mEPSC) signals.

> Hartveit E, Veruki ML. Studying properties of neurotransmitter receptors by non-stationary noise analysis of spontaneous postsynaptic currents and agonist-evoked responses in outside-out patches. Nat Protoc. 2007;2(2):434-48. doi: 10.1038/nprot.2007.47. PMID: 17406605.

---

# Steps

![NSFA Flowchart](../img/nsfa_flowchart.svg)

## 1. Align events by the point of fastest rise

Events must be aligned by the point of fastest rise. (See [`prepare_data.md`](../prepare_data.md))

All traces should have the same total trace length after alignment. (For demo data, the total trace length is 44.75 ms. Nearly all events decay back to baseline within this time window.)

Example of aligned traces and the average trace ↓

<img src="../img/aligned_traces.png" height="400">


## 2. Zero every trace

Zero every trace by the average amplitude of its own baseline (defined by user, e.g. 0 to 4 ms of the trace).

## 3. Drop unstable traces and traces with overlapping events

NSFA is sensitive to noise and signal stability as amplitude fluctuation is being analyzed. To control data quality, bad traces are removed from the analysis.

For more information, see [signal_inspection.md](../signal_processing_algorithms/signal_inspection.md).

## 4. Get the average trace of all remaining traces
An average trace can be generated by averaging amplitude of all traces at each time point.

## 5. Find peak location

The location of the peak of a downward signal is defined as the first sampling point with minimum value.

## 6. Locate decay window

The decay window is defined by the user, e.g. from 95% to 10% of the peak.

To locate the window, the theoretical amplitude at 95% of peak and at 10% of peak are calculated from the average peak amplitude as the amplitude at decay start point and at decay end point respectively. Sampling points matching the exact theoretical amplitudes likely do not exist in the trace, but the points nearest to the theoretical decay start point and end point can be used. To minimize the effect of noise on decay window location, three sampling points are used as the search window for the decay start point and end point.

Locations of decay start point and end point ↓

<img src="../img/analysis_start_end_points.png" height = 300>

## 7. Compute mean of amplitude (μ) at each time point within the decay window

## 8. Compute amplitude variance (σ^2) at each time point within the decay window using peak-scaled average trace

To get the peak-scaled average trace, scale average trace so that its peak amplitude equals to the amplitude of the trace being compared to at the same time point.

## 9. Fit data to model to find i and N

Using the mean and variance computed in previous steps, the variance-mean relationship of can be fitted with the following function based on a binomial model for quantal neurotransmitter release:

$σ^2 = i\cdotμ - \dfrac{μ^2}{N} + σ_{background}^2$ 

Single-channel current (i) and number of channels (N) can be obtained from the fitting results.
 
Fitting results ↓

<img src="../img/nsfa_fit.png" height = 300>
